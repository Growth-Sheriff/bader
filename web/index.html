<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BADER - Belge Tarama</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --success-hover: #16a34a;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 12px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .brand h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .brand span {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #dcfce7;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: #166534;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Steps Indicator */
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            position: relative;
        }
        
        .steps::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--gray-200);
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .step.active .step-circle {
            background: var(--primary);
            color: white;
        }
        
        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 11px;
            color: var(--gray-500);
            text-align: center;
        }
        
        .step.active .step-label {
            color: var(--primary);
            font-weight: 500;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-50);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: #dbeafe;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .upload-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 4px;
        }
        
        .upload-hint {
            font-size: 13px;
            color: var(--gray-500);
        }
        
        .upload-area input {
            display: none;
        }
        
        /* Preview */
        .preview-container {
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Loading */
        .loading-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--gray-600);
        }
        
        /* OCR Results */
        .result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .result-icon {
            width: 40px;
            height: 40px;
            background: #dcfce7;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .result-title h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .result-title span {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        /* Result Table */
        .result-table {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .result-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            flex: 0 0 100px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .result-value {
            flex: 1;
            font-size: 15px;
            color: var(--gray-900);
            font-weight: 500;
        }
        
        .result-value input,
        .result-value select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .result-value input:focus,
        .result-value select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Raw Text Toggle */
        .raw-text-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .raw-text-toggle span {
            font-size: 13px;
            color: var(--gray-600);
        }
        
        .raw-text-content {
            background: var(--gray-900);
            color: #e5e5e5;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            display: none;
        }
        
        .raw-text-content.show {
            display: block;
        }
        
        /* Kayƒ±t T√ºr√º Se√ßimi */
        .kayit-turu-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .kayit-turu-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .kayit-turu-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .kayit-turu-option {
            padding: 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .kayit-turu-option:hover {
            border-color: var(--gray-300);
        }
        
        .kayit-turu-option.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .kayit-turu-option.gider.selected {
            border-color: var(--danger);
            background: #fef2f2;
        }
        
        .kayit-turu-option .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .kayit-turu-option .label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        /* Gider/Gelir Kategorileri */
        .kategori-section {
            margin-bottom: 20px;
        }
        
        .kategori-section label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 8px;
        }
        
        .kategori-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        @media (max-width: 400px) {
            .kategori-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .kategori-chip {
            padding: 10px 8px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .kategori-chip:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }
        
        .kategori-chip.selected {
            border-color: var(--primary);
            background: #eff6ff;
            color: var(--primary);
        }
        
        .kategori-chip .emoji {
            font-size: 18px;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-hover);
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }
        
        .btn-outline:hover {
            border-color: var(--gray-400);
            background: var(--gray-50);
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: calc(100% - 40px);
        }
        
        .toast.success {
            background: var(--success);
            color: white;
        }
        
        .toast.error {
            background: var(--danger);
            color: white;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* √ñzet Card */
        .ozet-card {
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            border-radius: var(--radius);
            padding: 20px;
            color: white;
            margin-bottom: 16px;
        }
        
        .ozet-card h3 {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 16px;
        }
        
        .ozet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .ozet-stat {
            text-align: center;
        }
        
        .ozet-stat .value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .ozet-stat .label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        /* Quick Info */
        .quick-info {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .quick-info-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--gray-100);
            border-radius: 8px;
            font-size: 13px;
            color: var(--gray-700);
        }
        
        .quick-info-item.highlight {
            background: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">üèõÔ∏è</div>
                    <div class="brand">
                        <h1>BADER</h1>
                        <span>Belge Tarama Demo</span>
                    </div>
                </div>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span>Baƒülƒ±</span>
                </div>
            </div>
        </div>
        
        <!-- √ñzet -->
        <div class="ozet-card" id="ozet-card">
            <h3>üìä Dernek Durumu</h3>
            <div class="ozet-stats">
                <div class="ozet-stat">
                    <div class="value" id="stat-uye">-</div>
                    <div class="label">Aktif √úye</div>
                </div>
                <div class="ozet-stat">
                    <div class="value" id="stat-bakiye">-</div>
                    <div class="label">Net Bakiye</div>
                </div>
            </div>
        </div>
        
        <!-- Steps -->
        <div class="card">
            <div class="steps">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Belge Y√ºkle</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Tarama</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Onay & Kayƒ±t</div>
                </div>
            </div>
            
            <!-- Step 1: Upload -->
            <div id="panel-upload">
                <label class="upload-area" id="upload-area">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Belge Se√ßin veya S√ºr√ºkleyin</div>
                    <div class="upload-hint">Fatura, fi≈ü, dekont, makbuz...</div>
                    <input type="file" id="file-input" accept="image/*">
                </label>
            </div>
            
            <!-- Step 1b: Preview -->
            <div id="panel-preview" class="hidden">
                <div class="preview-container">
                    <img id="preview-image" class="preview-image">
                    <button class="btn btn-primary" onclick="startScan()">
                        üîç Belgeyi Tara
                    </button>
                    <button class="btn btn-outline" style="margin-top: 10px" onclick="resetAll()">
                        ‚Ü©Ô∏è Ba≈üka Belge Se√ß
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Loading -->
            <div id="panel-loading" class="hidden">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <div class="loading-text">Belge taranƒ±yor...</div>
                    <div style="font-size: 12px; color: var(--gray-400); margin-top: 8px;">OCR ile metin √ßƒ±karƒ±lƒ±yor</div>
                </div>
            </div>
            
            <!-- Step 3: Results -->
            <div id="panel-results" class="hidden">
                <div class="result-header">
                    <div class="result-icon">‚úÖ</div>
                    <div class="result-title">
                        <h3>Tarama Tamamlandƒ±</h3>
                        <span id="scan-time">0.00 saniye</span>
                    </div>
                </div>
                
                <!-- Quick Info -->
                <div class="quick-info">
                    <div class="quick-info-item highlight" id="quick-tutar">
                        üí∞ <span>-</span>
                    </div>
                    <div class="quick-info-item" id="quick-tarih">
                        üìÖ <span>-</span>
                    </div>
                </div>
                
                <!-- Extracted Data -->
                <div class="result-table">
                    <div class="result-row">
                        <div class="result-label">üí∞ Tutar</div>
                        <div class="result-value">
                            <input type="number" id="edit-tutar" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="result-row">
                        <div class="result-label">üìÖ Tarih</div>
                        <div class="result-value">
                            <input type="date" id="edit-tarih">
                        </div>
                    </div>
                    <div class="result-row">
                        <div class="result-label">üìù A√ßƒ±klama</div>
                        <div class="result-value">
                            <input type="text" id="edit-aciklama" placeholder="Belge a√ßƒ±klamasƒ±...">
                        </div>
                    </div>
                </div>
                
                <!-- Raw Text -->
                <div class="raw-text-toggle" onclick="toggleRawText()">
                    <span>üìÉ Ham OCR √áƒ±ktƒ±sƒ±</span>
                    <span id="raw-toggle-icon">‚ñº</span>
                </div>
                <pre class="raw-text-content" id="raw-text"></pre>
                
                <!-- Kayƒ±t T√ºr√º -->
                <div class="kayit-turu-section">
                    <h4>‚ùì Bu belge ne t√ºr√ºnde?</h4>
                    <div class="kayit-turu-options">
                        <div class="kayit-turu-option gider selected" data-type="gider" onclick="selectKayitTuru('gider')">
                            <div class="icon">üí∏</div>
                            <div class="label">Gider</div>
                        </div>
                        <div class="kayit-turu-option" data-type="gelir" onclick="selectKayitTuru('gelir')">
                            <div class="icon">üí∞</div>
                            <div class="label">Gelir</div>
                        </div>
                    </div>
                </div>
                
                <!-- Kategori Se√ßimi -->
                <div class="kategori-section" id="kategori-section">
                    <label id="kategori-label">Gider Kategorisi Se√ßin:</label>
                    <div class="kategori-grid" id="kategori-grid">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="resetAll()">
                        ‚Ü©Ô∏è Yeni Tara
                    </button>
                    <button class="btn btn-success" id="btn-save" onclick="saveRecord()">
                        ‚úì Onayla & Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API = '/api';
        let ocrData = null;
        let selectedFile = null;
        let selectedKayitTuru = 'gider';
        let selectedKategori = null;
        
        // Kategoriler
        const giderKategorileri = [
            { id: 'ELEKTRƒ∞K', label: 'Elektrik', emoji: '‚ö°' },
            { id: 'SU', label: 'Su', emoji: 'üíß' },
            { id: 'DOƒûALGAZ', label: 'Doƒüalgaz', emoji: 'üî•' },
            { id: 'ƒ∞NTERNET', label: 'ƒ∞nternet', emoji: 'üì∂' },
            { id: 'TELEFON', label: 'Telefon', emoji: 'üìû' },
            { id: 'Kƒ∞RA', label: 'Kira', emoji: 'üè†' },
            { id: 'TEMƒ∞ZLƒ∞K', label: 'Temizlik', emoji: 'üßπ' },
            { id: 'BAKIM-ONARIM', label: 'Bakƒ±m', emoji: 'üîß' },
            { id: 'KIRTASIYE', label: 'Kƒ±rtasiye', emoji: 'üìé' },
            { id: 'ORGANƒ∞ZASYON', label: 'Organizasyon', emoji: 'üéâ' },
            { id: 'YEMEK', label: 'Yemek', emoji: 'üçΩÔ∏è' },
            { id: 'ULA≈ûIM', label: 'Ula≈üƒ±m', emoji: 'üöó' },
            { id: 'PERSONEL', label: 'Personel', emoji: 'üë•' },
            { id: 'VERGƒ∞-HAR√á', label: 'Vergi/Har√ß', emoji: 'üìã' },
            { id: 'Sƒ∞GORTA', label: 'Sigorta', emoji: 'üõ°Ô∏è' },
            { id: 'Dƒ∞ƒûER', label: 'Diƒüer', emoji: 'üì¶' }
        ];
        
        const gelirKategorileri = [
            { id: 'Aƒ∞DAT', label: 'Aidat', emoji: 'üí≥' },
            { id: 'BAƒûI≈û', label: 'Baƒüƒ±≈ü', emoji: 'üéÅ' },
            { id: 'Kƒ∞RA', label: 'Kira Geliri', emoji: 'üè†' },
            { id: 'ETKƒ∞NLƒ∞K', label: 'Etkinlik', emoji: 'üé≠' },
            { id: 'FAƒ∞Z', label: 'Faiz', emoji: 'üè¶' },
            { id: 'PROJE', label: 'Proje', emoji: 'üìä' },
            { id: 'Dƒ∞ƒûER', label: 'Diƒüer', emoji: 'üì¶' }
        ];
        
        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            loadOzet();
            setupFileInput();
            renderKategoriler();
        });
        
        // √ñzet y√ºkle
        async function loadOzet() {
            try {
                const res = await fetch(API + '/dernek/ozet');
                const data = await res.json();
                document.getElementById('stat-uye').textContent = data.aktif_uye || 0;
                document.getElementById('stat-bakiye').textContent = formatMoney(data.net_bakiye || 0);
            } catch (e) {
                console.error('√ñzet y√ºkleme hatasƒ±:', e);
            }
        }
        
        // Para formatla
        function formatMoney(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Dosya input setup
        function setupFileInput() {
            var fileInput = document.getElementById('file-input');
            var uploadArea = document.getElementById('upload-area');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and Drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: fileInput });
                }
            });
        }
        
        // Dosya se√ßildi
        function handleFileSelect(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            
            var reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById('preview-image').src = ev.target.result;
                showPanel('preview');
            };
            reader.readAsDataURL(file);
        }
        
        // Tarama ba≈ülat
        async function startScan() {
            if (!selectedFile) return;
            
            showPanel('loading');
            setStep(2);
            
            var reader = new FileReader();
            reader.onload = async function() {
                var base64 = reader.result.split(',')[1];
                
                try {
                    var res = await fetch(API + '/ocr/demo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_base64: base64,
                            filename: selectedFile.name
                        })
                    });
                    
                    var data = await res.json();
                    
                    if (data.success) {
                        ocrData = data;
                        displayResults(data);
                        showPanel('results');
                        setStep(3);
                    } else {
                        showToast('OCR hatasƒ±: ' + (data.detail || 'Bilinmeyen hata'), true);
                        resetAll();
                    }
                } catch (e) {
                    showToast('Baƒülantƒ± hatasƒ±!', true);
                    resetAll();
                }
            };
            reader.readAsDataURL(selectedFile);
        }
        
        // Sonu√ßlarƒ± g√∂ster
        function displayResults(data) {
            // S√ºre
            document.getElementById('scan-time').textContent = (data.processing_time || 0) + ' saniye';
            
            // Quick info
            var tutarEl = document.getElementById('quick-tutar').querySelector('span');
            var tarihEl = document.getElementById('quick-tarih').querySelector('span');
            tutarEl.textContent = data.tutar ? formatMoney(data.tutar) : 'Tutar bulunamadƒ±';
            tarihEl.textContent = data.tarih || 'Tarih bulunamadƒ±';
            
            // Form
            document.getElementById('edit-tutar').value = data.tutar || '';
            document.getElementById('edit-aciklama').value = data.aciklama || (data.lines && data.lines[0]) || '';
            
            // Tarih
            if (data.tarih) {
                // T√ºrk formatƒ±ndan ISO formatƒ±na √ßevir
                var parts = data.tarih.split(/[./]/);
                if (parts.length === 3) {
                    var year = parts[2];
                    if (year.length === 2) year = '20' + year;
                    document.getElementById('edit-tarih').value = year + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                }
            } else {
                document.getElementById('edit-tarih').value = new Date().toISOString().split('T')[0];
            }
            
            // Raw text
            document.getElementById('raw-text').textContent = data.raw_text || '';
        }
        
        // Kayƒ±t t√ºr√º se√ß
        function selectKayitTuru(type) {
            selectedKayitTuru = type;
            selectedKategori = null;
            
            document.querySelectorAll('.kayit-turu-option').forEach(function(el) {
                el.classList.remove('selected');
            });
            document.querySelector('.kayit-turu-option[data-type="' + type + '"]').classList.add('selected');
            
            document.getElementById('kategori-label').textContent = 
                type === 'gider' ? 'Gider Kategorisi Se√ßin:' : 'Gelir Kategorisi Se√ßin:';
            
            renderKategoriler();
        }
        
        // Kategorileri render et
        function renderKategoriler() {
            var grid = document.getElementById('kategori-grid');
            var kategoriler = selectedKayitTuru === 'gider' ? giderKategorileri : gelirKategorileri;
            
            var html = '';
            kategoriler.forEach(function(k) {
                html += '<div class="kategori-chip" data-id="' + k.id + '" onclick="selectKategori(\'' + k.id + '\')">' +
                    '<span class="emoji">' + k.emoji + '</span>' +
                    '<span>' + k.label + '</span>' +
                '</div>';
            });
            grid.innerHTML = html;
        }
        
        // Kategori se√ß
        function selectKategori(id) {
            selectedKategori = id;
            
            document.querySelectorAll('.kategori-chip').forEach(function(el) {
                el.classList.remove('selected');
            });
            document.querySelector('.kategori-chip[data-id="' + id + '"]').classList.add('selected');
        }
        
        // Ham metin toggle
        function toggleRawText() {
            var content = document.getElementById('raw-text');
            var icon = document.getElementById('raw-toggle-icon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('show');
                icon.textContent = '‚ñ≤';
            }
        }
        
        // Kaydet
        async function saveRecord() {
            var tutar = parseFloat(document.getElementById('edit-tutar').value);
            var tarih = document.getElementById('edit-tarih').value;
            var aciklama = document.getElementById('edit-aciklama').value;
            
            if (!tutar || tutar <= 0) {
                showToast('L√ºtfen ge√ßerli bir tutar girin!', true);
                return;
            }
            
            if (!selectedKategori) {
                showToast('L√ºtfen bir kategori se√ßin!', true);
                return;
            }
            
            var endpoint = selectedKayitTuru === 'gider' ? '/dernek/giderler' : '/dernek/gelirler';
            
            var btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Kaydediliyor...';
            
            try {
                var res = await fetch(API + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tutar: tutar,
                        tarih: tarih,
                        tur: selectedKategori,
                        aciklama: aciklama,
                        kasa: 'Ana Kasa',
                        kaynak: 'ocr-web'
                    })
                });
                
                if (res.ok) {
                    var turLabel = selectedKayitTuru === 'gider' ? 'Gider' : 'Gelir';
                    showToast('‚úÖ ' + turLabel + ' ba≈üarƒ±yla kaydedildi!');
                    loadOzet(); // √ñzeti g√ºncelle
                    setTimeout(function() { resetAll(); }, 1500);
                } else {
                    var err = await res.json();
                    showToast('Kayƒ±t hatasƒ±: ' + (err.detail || 'Bilinmeyen hata'), true);
                }
            } catch (e) {
                showToast('Baƒülantƒ± hatasƒ±!', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚úì Onayla & Kaydet';
            }
        }
        
        // Panel g√∂ster
        function showPanel(panel) {
            ['upload', 'preview', 'loading', 'results'].forEach(function(p) {
                document.getElementById('panel-' + p).classList.add('hidden');
            });
            document.getElementById('panel-' + panel).classList.remove('hidden');
        }
        
        // Step ayarla
        function setStep(step) {
            for (var i = 1; i <= 3; i++) {
                var el = document.getElementById('step-' + i);
                el.classList.remove('active', 'completed');
                if (i < step) el.classList.add('completed');
                if (i === step) el.classList.add('active');
            }
        }
        
        // Sƒ±fƒ±rla
        function resetAll() {
            ocrData = null;
            selectedFile = null;
            selectedKategori = null;
            document.getElementById('file-input').value = '';
            showPanel('upload');
            setStep(1);
            renderKategoriler();
        }
        
        // Toast
        function showToast(message, isError) {
            var existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            var toast = document.createElement('div');
            toast.className = 'toast ' + (isError ? 'error' : 'success');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        }
    </script>
</body>
</html>
